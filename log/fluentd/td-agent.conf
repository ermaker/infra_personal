<source>
  @type tail
  format json
  time_key time
  path /var/lib/docker/containers/*/*-json.log
  pos_file /var/lib/docker/containers/containers.log.pos
  time_format %Y-%m-%dT%H:%M:%S
  tag file.docker.*
</source>

<match file.docker.var.lib.docker.containers.*.*.log>
  @type docker_format
  container_id ${tag_parts[6]}
  tag tag.docker.${name}
</match>

<source>
  @type secure_forward
  self_hostname log
  shared_key "#{ENV['SHARED_KEY']}"
  secure no
</source>

<match tag.**>
  type record_reformer
  tag color
  <record>
    tag ${tag_suffix[1]}
  </record>
</match>

<match color>
  @type color_stripper
  tag decolorized
</match>

<match decolorized>
  @type rewrite_tag_filter
  rewriterule1 tag ^docker\..+_(.+)_\d+$ docker.$1
  rewriterule2 tag ^docker\.(.+)$ docker.$1
  rewriterule3 tag ^(.*)$ $1
</match>

<match **.honeypot>
  type record_reformer
  tag ${tag}.foreman
</match>

<filter **.kibana>
  @type parser
  format json
  key_name log
  reserve_data yes
</filter>

<match **.nginx-proxy>
  type record_reformer
  tag ${tag}.forego_
</match>

<filter **.forego_>
  @type parser
  format /^(?<service_name>.+?)(\.(?<service_number>\d+?))?\s+?\| (?<log>.+?)$/
  key_name log
  reserve_data yes
</filter>

<filter **.foreman>
  @type parser
  format /^(?<logged_time>\d{2}:\d{2}:\d{2}) (?<service_name>.+?)\.(?<service_number>\d+?)\s+\| (?<log>.+?)$/
  key_name log
  reserve_data yes
</filter>

<match **.forego_ **.foreman>
  @type rewrite_tag_filter
  rewriterule1 service_name ^(.+?)$ ${tag}.$1
  rewriterule2 service_name .* ${tag}.unknown
</match>

<filter **.dockergen>
  @type parser
  format /^(?<time>.+? .+?) (?<log>.+?)$/
  key_name log
  reserve_data yes
</filter>

<match **.nginx>
  @type rewrite_tag_filter
  rewriterule1 log ^(?<remote>.+?) (?<host>.+?) (?<user>.+?) \[(?<time>.+?)\] "(?<method>.+?)(?: (?<path>.+?)(?: (?<version>.+?))?)?" (?<code>.+?) (?<size>.+?) "(?<referer>.+?)" "(?<agent>.+?)"$ ${tag}.access
  rewriterule2 log ^(?<time>.+? .+?) \[(?<log_level>.+?)\] (?<pid>.+?)#(?<tid>.+?): (?<message>.+)$ ${tag}.error
  rewriterule3 log .* ${tag}.unknown
</match>

<filter **.nginx.access>
  @type parser
  format /^(?<remote>.+?) (?<host>.+?) (?<user>.+?) \[(?<time>.+?)\] "(?<method>.+?)(?: (?<path>.+?)(?: (?<version>.+?))?)?" (?<code>.+?) (?<size>.+?) "(?<referer>.+?)" "(?<agent>.+?)"$/
  time_format %d/%b/%Y:%H:%M:%S %z
  key_name log
  reserve_data yes
</filter>

<filter **.nginx.error>
  @type parser
  format /^(?<time>.+? .+?) \[(?<log_level>.+?)\] (?<pid>.+?)#(?<tid>.+?): (?<message>.+)$/
  key_name log
  reserve_data yes
</filter>

# <filter **.es>
#   @type parser
#   format json
#   key_name log
#   reserve_data yes
# </filter>

# <filter **.fluentd>
#   @type parser
#   format json
#   key_name log
#   reserve_data yes
# </filter>

# <filter **.redis>
#   @type parser
#   format json
#   key_name log
#   reserve_data yes
# </filter>

# <filter **.mongo>
#   @type parser
#   format json
#   key_name log
#   reserve_data yes
# </filter>

<match docker.** fluent.**>
  @type elasticsearch
  include_tag_key true
  hosts es:9200
  logstash_format true
  logstash_prefix docker

  # buffer
  buffer_type file
  buffer_path /var/lib/docker/fluentd/buffer/container.*.buffer
  buffer_chunk_limit 8m
  buffer_queue_limit 10000
  retry_limit 17
  flush_interval 5
</match>
